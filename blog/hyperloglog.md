---
title: "HyperLogLog"
tags: ["dsa"]
---

## å‰è¨€

ä»Šå¤©è¦ä¾†ä»‹ç´¹ä¸€å€‹é…·é…·çš„æ±è¥¿  
å°±æ˜¯æˆ‘å€‘é€™ç¯‡çš„ä¸»è§’ **HyperLogLog**   
åœ¨è«‹ä»–å‡ºå ´ä¹‹å‰æˆ‘å€‘å…ˆä¾†ä»‹ç´¹è¨ˆæ•¸å•é¡Œ  
å¦‚æœæˆ‘å€‘ä»Šå¤©è¦åœ¨ä¸€å †å…ƒç´ ä¸­ç®—å‡ºæœ‰å¹¾å€‹ä¸åŒçš„å…ƒç´ ï¼Œä½ æœƒæ€éº¼åšï¼Ÿ   
<!-- truncate -->
æœ€ç„¡è…¦çš„è§£æ³•å°±æ˜¯ç›´æ¥ä½¿ç”¨ç¨‹å¼èªè¨€å…§å»ºçš„é›†åˆä¸€å€‹ä¸€å€‹å¡é€²å»  
ä½†é€™å€‹åšæ³•åªé©åˆå°é‡çš„è³‡æ–™  
ç•¶ä»Šå¤©è³‡æ–™é‡ä¸Šåˆ°ä¸€å®šçš„ç¨‹åº¦æ™‚å…§å»ºçš„é›†åˆå°±æœƒåƒæ‰å·¨é‡çš„è¨˜æ†¶é«”   
é‚£ä»Šå¤©å¦‚æœæˆ‘å¯ä»¥å…è¨±ä¸€é»èª¤å·®å‘¢ï¼Ÿ  
åƒæ˜¯ç¶²ç«™çµ±è¨ˆäººæ•¸ä¸ä¸€å®šè¦åšåˆ°å®Œå…¨ç²¾ç¢º  
æŠ“å€‹ä¼°è¨ˆå€¼å³å¯ï¼Œé€™å°±æ˜¯æˆ‘å€‘ **HyperLogLog** å‡ºå ´çš„æ™‚å€™  
è®“æˆ‘å€‘æ­¡è¿ä»–ğŸ™ŒğŸ™Œ

## æ¦‚å¿µ
HyperLogLog æ˜¯ä¸€ç¨®é€éæ©Ÿç‡ä¾†ä¼°è¨ˆä¸€å€‹åŸºæ•¸çš„è³‡æ–™çµæ§‹  
åŒæ™‚ä½¿ç”¨éå¸¸å°‘çš„è³‡æ–™é‡ï¼Œå®Œç¾ç¬¦åˆæˆ‘å€‘çš„éœ€æ±‚ï¼Œè€¶   
é‚£æˆ‘å€‘å…ˆä»‹ç´¹ä»–çš„æ ¸å¿ƒåŸç†: **æ©Ÿç‡å°çš„äº‹æƒ…ä¸å®¹æ˜“ç™¼ç”Ÿ**  
æ›å¥è©±èªªï¼Œç•¶ä¸€å€‹æ©Ÿç‡å°çš„äº‹æƒ…ç™¼ç”Ÿæ™‚  
æˆ‘å€‘å¾ˆæœ‰å¯èƒ½å·²ç¶“æœ‰å¤§é‡çš„åŸºæ•¸äº†  
èˆ‰ä¾‹å¤§æ¨‚é€å¦‚æœä¸­çæ©Ÿç‡æ˜¯ 1%  
ç•¶ä½ æŠ½åˆ°æ™‚å°±æœƒè¦ºå¾—æ˜¯ 100 å€‹äººä¸­æœ€å¹¸é‹çš„  
ç•¶ç„¶æœ‰å¯èƒ½å¤šå€‹äººåŒæ™‚ä¸­çï¼Œè€Œä¸”å…·é«”å¹¾å€‹äººæŠ½æ˜¯ä¸çŸ¥é“    
ä½†æ˜¯ç›´è§€ä¸ŠåƒåŠ æŠ½ççš„äººæ•¸æ˜¯ä¸€å€‹æ¥è¿‘ 100 çš„æ•¸  
è€Œ Hyperloglog æ˜¯é€ééš¨æ©Ÿæ•¸é–‹é ­æœ‰å¹¾å€‹é€£çºŒçš„ 0 ä¾†è¡¨ç¤ºç™¼ç”Ÿçš„æ©Ÿç‡  
æ¯”æ–¹èªªé–‹é ­æœ‰é€£çºŒä¸‰å€‹ 0 ç™¼ç”Ÿçš„æ©Ÿç‡æ‡‰è©²æ˜¯ 1/8
### æ–°å¢å…ƒç´ 
é‚£è¬›å®Œæ ¸å¿ƒåŸç†å¾Œæˆ‘å€‘ä¾†çœ‹çœ‹ä»–æ˜¯æ€éº¼é‹ä½œçš„å§ï¼  
å‰›æ‰æåˆ°éš¨æ©Ÿæ•¸ï¼Œæˆ‘å€‘å¯ä»¥é€éé›œæ¹Šæƒ³ç´€éŒ„çš„å…ƒç´ ä¾†å¾—åˆ°ä¸€å€‹éš¨æ©Ÿæ•¸  
åº•ä¸‹åˆ—å‡ºä¸€äº›æˆ‘å€‘æœƒä½¿ç”¨åˆ°çš„è®Šæ•¸
* `m`: ä»£è¡¨é›œæ¹Šå€¼çš„å‰ `m` ä½ bits  
* `registers`: ä¸€å€‹å¤§å°ç‚º $2^m$ æ¬¡æ–¹çš„ arrayï¼Œåˆå§‹å€¼çš†ç‚º `0`

è€Œä»–æä¾›çš„æ“ä½œä¸»è¦æœ‰å…©å€‹ï¼Œä¸€å€‹æ˜¯åŠ å…¥ï¼Œå¦ä¸€å€‹æ˜¯ä¼°ç®—åŸºæ•¸  
åœ¨æˆ‘å€‘è¦åŠ å…¥æ–°çš„å…ƒç´ é€²å»æ™‚  
æˆ‘å€‘æœƒå…ˆå°‡è¦åŠ å…¥çš„å…ƒç´  hash æˆä¸€å€‹ 64 bits çš„æ•¸å­—  
ä¸¦å–å‡ºä»–çš„å‰ `m` å€‹ bits ç•¶æˆç´¢å¼•ï¼Œç”¨ä¾†å°‹æ‰¾å°æ‡‰çš„ register  
æ¥è‘—æˆ‘å€‘å°±æœƒç”¨å‰©ä¸‹çš„ `(64 - m)` bits æœ€å‰é¢æœ‰å¹¾å€‹é€£çºŒçš„ `0` ä¾†æ›´æ–°å°æ‡‰çš„ register  
ä½†è‹¥å°æ‡‰çš„ register åŸæœ¬çš„å€¼æ›´å¤§å°±ä¸æ›´æ–°     
å¯ä»¥çœ‹ä¸‹åœ–ä¾†æ›´æ˜ç™½ä¸€é»  
è—è‰²çš„éƒ¨åˆ†ç”¨ä¾†æ‰¾å°æ‡‰ registerï¼Œå‰©ä¸‹çš„éƒ¨åˆ†ç”¨ä¾†æ›´æ–° register
![](./img/hyperloglog/process.png)

:::info èˆ‰ä¾‹
æˆ‘å€‘ä»Šå¤©å‡è¨­ä¸€é–‹å§‹çš„ `m` è¨­å®šç‚º `2`  
ä¸¦ä¸”åŸå…ˆ Hyperloglog è£¡é¢ä¸¦æ²’æœ‰å„²å­˜ä»»ä½•æ±è¥¿  
é‚£å› ç‚º `m` æ˜¯ `2`ï¼Œæ‰€ä»¥æˆ‘å€‘éœ€è¦ `4` å€‹ register  
ç•¶æˆ‘å€‘ä»Šå¤©æ–°å¢ `hi` é€™å€‹å…ƒç´ æ™‚    
å‡è¨­ `hi` çš„ hash ç‚º `10001.......` (äºŒé€²ä½)  
æˆ‘å€‘å…ˆå–å‡ºä»–çš„å‰å…©å€‹ bits `10`ï¼Œå°æ‡‰çš„æ•¸å­—æ˜¯ `2`  
ä»£è¡¨æˆ‘å€‘è¦æ›´æ–°ç¬¬ä¸‰å€‹ register  
è€Œæ›´æ–°çš„å€¼ç‚º `2`ï¼Œå› ç‚ºå¾Œé¢çš„ `62` å€‹ bits é–‹é ­æœ‰ `2` å€‹é€£çºŒçš„ `0`  
ä½†è‹¥å°æ‡‰ register åŸæœ¬çš„å€¼å°±å¤§æ–¼ `2` å‰‡ä¸æ›´æ–°
:::

æˆ‘å€‘å¯ä»¥çœ‹åˆ° Hyperloglog è—‰ç”±å„²å­˜ç›®å‰å‡ºç¾æœ€å¤šé€£çºŒçš„ 0 çš„ä¾†ä¼°ç®—åŸºæ•¸  
é‚£é€™é‚Šå°±æœƒæœ‰å¦å¤–ä¸€å€‹å•é¡Œäº†ï¼Œç‚ºä»€éº¼éœ€è¦å¾ˆå¤šå€‹ register å‘¢ï¼Ÿ  
æˆ‘ç›´æ¥æŠŠå…¨éƒ¨ bits éƒ½æ‹¿ä¾†ç”¨ä¸å¥½å— ï¼Ÿ  
é€™å€‹å•é¡Œæˆ‘å€‘åœ¨ä¸‹é¢èªªæ˜ï½

### è¨ˆç®—åŸºæ•¸
æœ‰äº†å…ƒç´ ä¹‹å¾Œä¸‹ä¸€æ­¥å°±æ˜¯ä¾†ä¼°ç®— HyperLogLog è£¡é¢åˆ°åº•æœ‰å¤šå°‘å…ƒç´   
é‚£å…¬å¼çš„è©±å¦‚ä¸‹
$\alpha$ ç‚ºä¿®æ­£ä¿‚æ•¸ï¼Œåœ¨ [Redis çš„å¯¦ä½œ](https://github.com/redis/redis/blob/unstable/src/hyperloglog.c#L368C1-L368C47)ä¸­æ¡ç”¨çš„æ˜¯ `0.72134` ( $\frac{1}{2ln2}$ )  
é€™å€‹å€¼çš„å…·é«”ç”±ä¾†å¯èƒ½éœ€è¦åƒè€ƒåŸè«–æ–‡ï¼Œæˆ‘ä¹Ÿä¸æ¸…æ¥š XD  
è€Œ `m` çš„å«ç¾©èˆ‡ä¸Šä¸€ç¯€æåˆ°çš„ `m` ç›¸åŒ  
$$
Cardinality = \alpha \times m \times \frac{m}{\sum^m_{i = 1} 2 ^{-Register[i]}}
$$

çœ‹åˆ°é€™é‚Šä½ å¯èƒ½æœƒéå¸¸çŸ‡é€¼ï¼Œå…©å€‹ `m` å°¬éº»ä¸ä¹˜ä¸€èµ·è®Šæˆ $m^2$  
ä¸‹é¢é‚£ä¸€å¨åˆæ˜¯ä»€éº¼ï¼Ÿ
ä¸æ€¥ï¼Œæˆ‘å€‘å…ˆä¾†ä»‹ç´¹ä¸€ç¨®å¹³å‡æ³•

### èª¿å’Œå¹³å‡
æˆ‘å€‘ä¸€èˆ¬æœ€å¸¸è¦‹çš„å¹³å‡å°±æ˜¯å…¨éƒ¨ç›¸åŠ å†é™¤ä»¥ç¸½å€‹æ•¸ï¼Œé€™ç¨®å¹³å‡ç¨±ç‚ºç®—è¡“å¹³å‡æ•¸  
æ¯”å¦‚èªªæˆ‘è·Ÿéƒ­å°éŠ˜çš„è²¡ç”¢å¹³å‡å°±æ˜¯æˆ‘å€‘å…©å€‹çš„è²¡ç”¢ç›¸åŠ  $\div$ 2  
ä½†å› ç‚ºéƒ­å°éŠ˜å¤ªæœ‰éŒ¢äº†ï¼Œæ‰€ä»¥ä½ æœƒç™¼ç¾é€™å€‹å¹³å‡å¹¾ä¹ç­‰æ–¼éƒ­å°éŠ˜çš„è²¡ç”¢ $\div$ 2  
é€™å°±æ˜¯ç®—è¡“å¹³å‡æ•¸çš„å•é¡Œï¼Œå®¹æ˜“å› ç‚ºæ¥µç«¯çš„å€¼è€Œå¾—åˆ°æ²’æœ‰ä»€éº¼æ„ç¾©çš„çµæœã€‚  
ä»Šå¤©æˆ‘å€‘çš„ HyperLogLog å…¶å¯¦ä¹Ÿæœ‰é€™ç¨®å•é¡Œ  
æˆ‘å€‘æƒ³è—‰ç”±æœ€å¤šæœ‰å¹¾å€‹é€£çºŒçš„ 0 ä¾†ä¼°ç®—åŸºæ•¸  
ä½†æœ‰æ²’æœ‰å¯èƒ½åœ¨é‹æ°£çˆ†æ£šçš„æƒ…æ³ä¸‹ç¬¬ä¸€æ¬¡å°±å¾—åˆ°è¶…å¤šçš„ 0  
å°è‡´æˆ‘å€‘åš´é‡é«˜ä¼°æˆ‘å€‘çš„åŸºæ•¸  
åœ¨åŸæœ¬çš„è«–æ–‡ä¸­ä½¿ç”¨èª¿å’Œå¹³å‡æ•¸ä¾†é™ä½é€™ç¨®å½±éŸ¿  
å¦‚æœä»Šå¤©æœ‰ `n` å€‹å€¼ï¼Œå…¬å¼å¦‚ä¸‹   
$
\frac{n}{\frac{1}{m_1} + \dots + \frac{1}{m_n}}
$

:::info èˆ‰ä¾‹
å¦‚æœä»Šå¤©æˆ‘æœ‰ `10` å¡Šï¼Œéƒ­å°éŠ˜æœ‰ `10`è¬å¡Š  
é‚£æˆ‘å€‘çš„èª¿å’Œå¹³å‡å°±æ˜¯ $\frac{2}{\frac{1}{10} + \frac{1}{100000}} = 19.998$   
:::

### Back to åŸºæ•¸
æœ‰äº†ä¸Šé¢çš„å…¬å¼å¾Œï¼Œå†çœ‹çœ‹è¨ˆç®—åŸºæ•¸çš„æ­¥é©Ÿ  
æœ€å¾Œé‚£ä¸€é …å¾ˆå™å¿ƒçš„å€¼ä¸å°±æ˜¯å°æ‰€æœ‰è¨ˆæ•¸å™¨ä¸­çš„å€¼æ±‚èª¿å’Œå¹³å‡å—ï¼Ÿ  
æœƒèˆ‡ `2` çš„æ¬¡æ–¹æœ‰é—œæ˜¯å› ç‚ºæˆ‘å€‘æ˜¯äºŒé€²ä½ï¼Œé€£çºŒçš„ `n` å€‹ `0` å‡ºç¾çš„æ©Ÿç‡æ˜¯ $2^{-n}$  
é‚£èª¿å’Œå¹³å‡å‰é¢çš„é‚£å€‹ `m` æ„ç¾©å°±æ˜¯å¹³å‡ $\times$ å€‹æ•¸ $=$ ç¸½å’Œ  
æœ€å¾Œå†åšæˆ‘ä¸æ‡‚çš„ä¿®æ­£å¾—åˆ°æˆ‘å€‘æƒ³è¦çš„åŸºæ•¸  
ç¾åœ¨æˆ‘å€‘çŸ¥é“ç‚ºä»€éº¼è¦æœ‰å¾ˆå¤š register è€Œä¸æ˜¯ä¸€å€‹å€¼ä¾†å­˜é€£çºŒçš„ 0 çš„æœ€å¤§å€¼  
å› ç‚ºé€™æ¨£é€éå¾Œé¢èª¿å’Œå¹³å‡æ¸›å°‘æ¥µç«¯å½±éŸ¿  


## å‹•å‹•æ‰‹
æäº†é€™éº¼ä¹…è®“æˆ‘å€‘å¯«é»æ‰£ç©ç©çœ‹å§ï¼  
ç‚ºæ±‚å¿«é€Ÿå¯«çš„æœ‰é»é†œ..  
æœ€é–‹å§‹ç•¶ç„¶æ˜¯å®£å‘Šä¸€å€‹ class  
é‚„æœ‰æˆ‘å€‘æƒ³è¦çš„ registers å€‹æ•¸ (ç”± `m` æ§åˆ¶)  
bitmask æ˜¯æˆ‘å€‘ç‚ºæ–¹ä¾¿æ±‚ register çš„ indexï¼Œä»–çš„äºŒé€²ä½å°±æ˜¯ `m` å€‹ `1`
```py
#!/usr/bin/python3

import math
import uuid

class HyperLogLog:

    constant = 0.72134

    def __init__(self, m_bits) -> None:
        self.m_bits = m_bits
        self.registers = [0] * (1 << m_bits)
        self.register_bitmask = (1 << m_bits) - 1
```
    
æ¥ä¸‹ä¾†å°±æ˜¯æˆ‘å€‘çš„ hash function!  
è—‰ç”± % æŠ“å‡ºæœ€å¾Œçš„ `64` ä½  
ä½†è¦æ³¨æ„çš„æ˜¯ python çš„ hash è‹¥æ˜¯ä¸Ÿå…¥æ•¸å­—  
æœƒåŸå°ä¸å‹•çš„åå›ä½ å‚³å…¥çš„æ•¸å­—  
æ‰€ä»¥é€™å€‹ç¯„ä¾‹è«‹ä¸è¦ç„¡è…¦ç”¨å°æ•¸å­—ä¾†å¯¦é©—ï¼Œå¦å‰‡å¾—åˆ°çš„ hash æœƒä¸å¹³å‡  


```py
    @classmethod
    def hash(cls, data) -> int:
        # get last 64 bits
        return hash(data) % (1 << 64)
```
ä¸‹ä¸€æ­¥å°±æ˜¯æ‰¾å‡ºæœ‰å¹¾å€‹é€£çºŒçš„ `0`  
å…¶å¯¦å°±æ˜¯æ‰¾å‡ºç¬¬ä¸€å€‹ `1`  
ä½†è¦æ³¨æ„æ˜¯å¾å·¦é‚Šç¬¬ `m+1` å€‹ bit é–‹å§‹  
å‰é¢çš„æ˜¯è¦ç•¶æˆ register index  
é‚£æ€éº¼çŸ¥é“æŸä¸€ä½æ˜¯ä¸æ˜¯ `1` å‘¢  
æˆ‘å€‘å¯ä»¥ç”¨å·¦ä½ç§»ä¾†åšå‡ºä¸€å€‹ `00100...0` (äºŒé€²ä½) çš„å€¼  
é‚£å€‹ 1 çš„ä½ç½®å°±æ˜¯æˆ‘å€‘æƒ³ç¢ºèªçš„ä½ç½®ï¼Œæ­é… & å°±å¯ä»¥çŸ¥é“äº†ï¼
```py
    def first_1_bit_position(self, hash_val)->int:
        """
        the structure of hash_val's bits: [m_bits, 64 - m_bits]
        find the first 1 position lies in the right part (64 - m_bits)
        """
        
        
        # from left to right
        for bit_pos in range(self.m_bits, 64):
        
            bit_mask = (1 << (64 - bit_pos - 1))
            
            if hash_val & bit_mask:
                return bit_pos - self.m_bits + 1

        return 64 - self.m_bits
```
æˆ‘å€‘é‚„éœ€è¦çŸ¥é“æŸå€‹ hash å°æ‡‰çš„ register æ˜¯å“ªå€‹  
é€™ä¹Ÿå¾ˆç°¡å–®ï¼Œå› ç‚ºæˆ‘å€‘æœ‰ä¸€é–‹å§‹åˆå§‹åŒ–çš„ bitmask äº†  
åªè¦æŠ“å‡ºå‰ `m` å€‹ bits & ä¸€ä¸‹å°±çŸ¥é“çµæœäº†ï¼  
æŠ“å‡ºå‰ `m` å€‹ bits æœ€ç°¡å–®çš„æ–¹å¼å°±æ˜¯ç›´æ¥å³ä½ç§» >>
```py
    def get_register_index(self, hash_val): 

        return (hash_val >> (64 - self.m_bits)) & self.register_bitmask
```
å¿«çµæŸäº†ï¼ï¼ æˆ‘å€‘çš„ç¬¬ä¸€å€‹æ“ä½œ `add_element`  
åšçš„äº‹æƒ…ä¹Ÿå¾ˆç°¡å–®
hash å®Œï¼Œæ‰¾å‡ºå°æ‡‰çš„ registerï¼Œæ›´æ–°
```py
    def add_element(self, obj):
        hash_val = hash(obj)
        
        register_index = self.get_register_index(hash_val)

        self.registers[register_index] = max(self.registers[register_index], self.first_1_bit_position(hash_val))
```
æœ€å¾Œä¸€æ­¥ï¼Œå¥—å…¬å¼ğŸ¥³  
æˆ‘å€‘å¯ä»¥ç”¨ python çš„ sum ä»¥åŠ list comprehension ä¾†å–ä»£é†œé†œçš„è¿´åœˆ
```py
    def get_cardinality(self):
        harmonic_mean = len(self.registers) / sum(pow(2, -register) for register in self.registers)
        
        return math.floor(harmonic_mean * len(self.registers) * self.constant)
```


æœ‰èˆˆè¶£çš„å¯ä»¥è¤‡è£½ä¸‹é¢çš„æ‰£å»ç© ğŸ˜µâ€ğŸ’«
<details>

<summary>Code</summary>


```py title="hyperloglog.py"
#!/usr/bin/python3

import math
import uuid

class HyperLogLog:

    constant = 0.72134

    def __init__(self, m_bits) -> None:
        self.m_bits = m_bits
        self.registers = [0] * (1 << m_bits)
        self.register_bitmask = (1 << m_bits) - 1 

    

    @classmethod
    def hash(cls, data) -> int:
        return hash(data) % (1 << 64)
        

    def first_1_bit_position(self, hash_val)->int:
        """
        the structure of hash_val's bits: [m_bits, 64 - m_bits]
        find the first 1 position lies in the right part (64 - m_bits)
        """
        
        
        # from left to right
        for bit_pos in range(self.m_bits, 64):
        
            bit_mask = (1 << (64 - bit_pos - 1))
            
            if hash_val & bit_mask:
                return bit_pos - self.m_bits + 1

        return 64 - self.m_bits
    
    def get_register_index(self, hash_val): 
        return (hash_val >> (64 - self.m_bits)) & self.register_bitmask
        
    def add_element(self, obj):
        hash_val = hash(obj)
        
        register_index = self.get_register_index(hash_val)

        self.registers[register_index] = max(self.registers[register_index], self.first_1_bit_position(hash_val))
    
    def get_cardinality(self):
        harmonic_mean = len(self.registers) / sum(pow(2, -register) for register in self.registers)
        
        return math.floor(harmonic_mean * len(self.registers) * self.constant)
    



cardinality = 10 ** 7

if __name__ == "__main__":
    hll = HyperLogLog(14)
    for i in range(cardinality):
        hll.add_element(str(uuid.uuid4()))
    print(hll.get_cardinality())
```

</details>




## Reference
* [HyperLogLog](https://algo.inria.fr/flajolet/Publications/FlFuGaMe07.pdf)